<% layout('layouts/boilerplate') %>
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Inter', sans-serif;
        }

        .listing-grid-container {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        .main-listing-card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .main-image-wrapper img {
            width: 60%;
            height: 60%;
            object-fit: cover;
            border-radius: 1.5rem;
            display: block;
            margin: 0 auto;
        }

        @media (max-width: 991px) {
            .main-listing-card {
                border-radius: 1rem;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.10);
            }

            .main-image-wrapper img {
                border-radius: 1rem;
                height: 220px;
                object-fit: cover;
            }

            .listing-details-section {
                padding: 1rem;
            }

            .owner-info-card {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
            }

            .features-list {
                flex-direction: column;
                gap: 0.5rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem !important;
            }

            .section-title {
                font-size: 1.3rem;
            }

            #map {
                height: 220px;
            }
        }

        @media (max-width: 575px) {
            .main-listing-card {
                border-radius: 0.5rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
            }

            .main-image-wrapper img {
                border-radius: 0.5rem;
                height: 140px;
            }

            .listing-details-header h1 {
                font-size: 1.3rem;
            }

            .listing-details-header p,
            .price-tag {
                font-size: 1rem;
            }

            .features-list li {
                font-size: 0.8rem;
                padding: 6px 10px;
            }

            .owner-info-card {
                padding: 0.5rem;
            }

            .action-buttons {
                padding: 0.5rem !important;
            }

            .section-title {
                font-size: 1rem;
            }

            #map {
                height: 120px;
            }
        }

        .listing-details-section {
            padding: 2rem;
        }

        .listing-details-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .listing-details-header p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }

        .price-tag {
            font-size: 1.8rem;
            font-weight: 600;
            color: #34495e;
        }

        .price-tag small {
            color: #8c909c;
            font-size: 1rem;
            font-weight: 400;
        }

        .features-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .features-list li {
            background: #f8f9fa;
            border-radius: 50px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: #555;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .owner-info-card {
            background: #f8f9fa;
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .owner-info-card i {
            font-size: 1.5rem;
            color: #ff5a5f;
        }

        .action-buttons {
            margin-top: 2rem;
        }

        .action-buttons .btn {
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: 600;
        }

        .reviews-details-area {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .review-card {
            background: #f8f9fa;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .details-card {
            background-color: #fff;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        .details-card ul {
            list-style: none;
            padding: 0;
        }

        .details-card ul li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .details-card ul li:last-child {
            border-bottom: none;
        }

        .map-area {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        #map {
            height: 400px;
            border-radius: 1rem;
            width: 100%;
        }

        @media (max-width: 991px) {
            .image-gallery-grid {
                height: 300px;
            }
        }
    </style>

    <div class="container-fluid listing-grid-container">

        <div class="row g-4 mb-4">
            <div class="col-12">
                <a href="/listings" class="btn btn-outline-secondary mb-4"><i
                        class="fa-solid fa-arrow-left me-2"></i>Back to Listings</a>
                <div class="main-image-wrapper">
                    <img src="<%= listing.image.url %>" alt="<%= listing.title %> image" loading="lazy"
                        onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=60'; this.alt='Image not available';">
                </div>
            </div>
        </div>

        <div class="row g-4 mt-4">
            <div class="col-lg-6">
                <div class="main-listing-card h-100 d-flex flex-column">
                    <div class="listing-details-section">
                        <div class="listing-details-header">
                            <h1>
                                <%= listing.title %>
                            </h1>
                            <p class="text-muted">
                                <%= listing.location %>, <%= listing.country %>
                            </p>
                            <p class="price-tag">₹<%= listing.price ? listing.price.toLocaleString('en-IN') : "N/A" %>
                                    <small>/ night</small></p>
                        </div>
                        <hr>
                        <p>
                            <%= listing.description %>
                        </p>
                        <ul class="features-list mt-3">
                            <li><i class="fa-solid fa-bed"></i> 4 Beds</li>
                            <li><i class="fa-solid fa-bath"></i> 2 Baths</li>
                            <li><i class="fa-solid fa-wifi"></i> Free Wifi</li>
                            <li><i class="fa-solid fa-kitchen-set"></i> Kitchen</li>
                        </ul>
                        <div class="owner-info-card mt-4">
                            <i class="fa-solid fa-user-circle"></i>
                            <div>
                                <span class="fw-bold d-block">Hosted by <%= listing.owner.username %></span>
                                <span class="text-muted">Superhost · 2 years</span>
                            </div>
                        </div>
                    </div>

                    <% if(currentUser && listing.owner._id.equals(currentUser._id)) { %>
                        <div class="action-buttons p-4 mt-auto d-flex justify-content-between gap-3 border-top">
                            <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-primary">Edit Listing</a>
                            <form method="post" action="/listings/<%= listing._id %>?_method=DELETE"
                                onsubmit="return confirm('Are you sure?');">
                                <button type="submit" class="btn btn-outline-danger">Delete</button>
                            </form>
                        </div>
                        <% } %>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="p-4 bg-white rounded-3 shadow-sm h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="section-title mb-0">Reviews</h3>
                        <button class="btn btn-outline-primary" id="writeReviewBtn">Write Review</button>
                    </div>

                    <% if (listing.reviews && listing.reviews.length> 0) { %>
                        <div>
                            <% if (currentUser) { %>
                                <% for (let i=0; i < Math.min(listing.reviews.length, 3); i++) { %>
                                    <% const review=listing.reviews[i]; %>
                                        <div class="review-card d-flex align-items-center mb-3">
                                            <div>
                                                <span class="fw-bold">
                                                    <%= review.author.username %>
                                                </span>
                                                <p class="starability-result mb-1" data-rating="<%= review.rating %>">
                                                </p>
                                                <p class="card-text mb-0">
                                                    <%= review.comment %>
                                                </p>
                                            </div>
                                            <% if(currentUser && review.author._id.equals(currentUser._id)) { %>
                                                <form class="ms-auto" method="post"
                                                    action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                                                    onsubmit="return confirm('Are you sure?');">
                                                    <button class="btn btn-sm btn-outline-danger">Delete</button>
                                                </form>
                                                <% } %>
                                        </div>
                                        <% } %>
                                            <% } else { %>
                                                <% for (let i=0; i < Math.min(listing.reviews.length, 2); i++) { %>
                                                    <% const review=listing.reviews[i]; %>
                                                        <div class="review-card d-flex align-items-center mb-3">
                                                            <div>
                                                                <span class="fw-bold">
                                                                    <%= review.author.username %>
                                                                </span>
                                                                <p class="starability-result mb-1"
                                                                    data-rating="<%= review.rating %>"></p>
                                                                <p class="card-text mb-0">
                                                                    <%= review.comment %>
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <% } %>
                                                            <% } %>
                        </div>

                        <% if (currentUser && listing.reviews.length> 3 || !currentUser && listing.reviews.length > 2) {
                            %>
                            <div class="text-center mt-3">
                                <button class="btn btn-link" data-bs-toggle="modal"
                                    data-bs-target="#allReviewsModal">Show All Reviews (<%= listing.reviews.length %>
                                        )</button>
                            </div>
                            <% } %>
                                <% } else { %>
                                    <p class="text-muted text-center">No reviews yet.</p>
                                    <% } %>
                </div>
            </div>
        </div>

        <div class="row map-area g-4 mt-4">
            <div class="col-12">
                <div class="p-4 bg-white rounded-3 shadow-sm h-100 d-flex flex-column">
                    <h3 class="section-title text-center mb-4">Location</h3>
                    <div id="map" class="flex-grow-1"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewModalLabel">Leave a Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/listings/<%= listing.id %>/reviews" method="post" novalidate
                        class="needs-validation">
                        <div class="mb-3">
                            <label for="rating" class="form-label fw-bold">Rating</label>
                            <fieldset class="starability-growRotate">
                                <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1"
                                    checked aria-label="No rating." />
                                <input type="radio" id="first-rate1" name="review[rating]" value="1" /><label
                                    for="first-rate1" title="Terrible">1 star</label>
                                <input type="radio" id="first-rate2" name="review[rating]" value="2" /><label
                                    for="first-rate2" title="Not good">2 stars</label>
                                <input type="radio" id="first-rate3" name="review[rating]" value="3" /><label
                                    for="first-rate3" title="Average">3 stars</label>
                                <input type="radio" id="first-rate4" name="review[rating]" value="4" /><label
                                    for="first-rate4" title="Very good">4 stars</label>
                                <input type="radio" id="first-rate5" name="review[rating]" value="5" /><label
                                    for="first-rate5" title="Amazing">5 stars</label>
                            </fieldset>
                        </div>
                        <div class="mb-3">
                            <label for="comment" class="form-label fw-bold">Comment</label>
                            <textarea id="comment" name="review[comment]" rows="3" class="form-control"
                                required></textarea>
                        </div>
                        <button class="btn btn-success fw-bold w-100">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="allReviewsModal" tabindex="-1" aria-labelledby="allReviewsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allReviewsModalLabel">All Reviews (<%= listing.reviews.length %>)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <% if (listing.reviews && listing.reviews.length> 0) { %>
                        <% for (review of listing.reviews) { %>
                            <div class="review-card d-flex align-items-center mb-3">
                                <div>
                                    <span class="fw-bold">
                                        <%= review.author.username %>
                                    </span>
                                    <p class="starability-result mb-1" data-rating="<%= review.rating %>"></p>
                                    <p class="card-text mb-0">
                                        <%= review.comment %>
                                    </p>
                                </div>
                                <% if(currentUser && review.author._id.equals(currentUser._id)) { %>
                                    <form class="ms-auto" method="post"
                                        action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                                        onsubmit="return confirm('Are you sure?');">
                                        <button class="btn btn-sm btn-outline-danger">Delete</button>
                                    </form>
                                    <% } %>
                            </div>
                            <% } %>
                                <% } %>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/map.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const writeReviewBtn = document.getElementById('writeReviewBtn');
            const currentUser = `<%= currentUser ? 'true' : '' %>`; // Check if currentUser exists

            if (writeReviewBtn) {
                writeReviewBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (currentUser) {
                        const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
                        reviewModal.show();
                    } else {
                        window.location.href = '/login';
                    }
                });
            }
        });
    </script>